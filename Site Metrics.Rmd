---
title: "Site Metrics"
author: "Chelsea Ursaner"
date: "2/15/2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Precipitation this season

```{r warning=FALSE, message=FALSE}
# props to Aida from UCLA stats for writing this web scraping script!
# Load necessary packages -------------------------------------------------

library(httr)
library(rvest)
library(dplyr)

# Read html pages, scrape raw data -----------------------------------------
# LA DUCOMMUN RAIN GAUGE - recorded twice daily

ducommun_scrape <- read_html("http://dpw.lacounty.gov/wrd/precip/alert_rain/season_raindata.cfm?id=377")

ducommun_table <- ducommun_scrape %>% html_nodes("td, th") %>% html_text() %>% as.data.frame()
ducommun_table <- ducommun_table[2:nrow(ducommun_table), 1] %>% as.data.frame()

# Format raw data into table ----------------------------------------------
ducommun <- split(ducommun_table, 1:4) %>% as.data.frame()
names(ducommun) <- c("Date_Time", "Raw_Count", "Amount_inches", "Accumulated_inches")
rownames(ducommun) <- 1:nrow(ducommun)
ducommun <- ducommun[2:nrow(ducommun), ]

# USC RAIN GAUGE - recorded hourly

USC_scrape <- read_html("http://dpw.lacounty.gov/wrd/precip/alert_rain/season_raindata.cfm?id=375")

USC_table <- USC_scrape %>% html_nodes("td, th") %>% html_text() %>% as.data.frame()
USC_table <- USC_table[2:nrow(USC_table), 1] %>% as.data.frame()

# Format raw data into table ----------------------------------------------
USC <- split(USC_table, 1:4) %>% as.data.frame()
names(USC) <- c("Date_Time", "Raw_Count", "Amount_inches", "Accumulated_inches")
rownames(USC) <- 1:nrow(USC)
USC <- USC[2:nrow(USC), ]

# SCHOOLHOUSE RAIN GAUGE - recorded twice daily

schoolhouse_scrape <- read_html("http://dpw.lacounty.gov/wrd/precip/alert_rain/season_raindata.cfm?id=450")

schoolhouse_table <- schoolhouse_scrape %>% html_nodes("td, th") %>% html_text() %>% as.data.frame()
schoolhouse_table <- schoolhouse_table[2:nrow(schoolhouse_table), 1] %>% as.data.frame()

# Format raw data into table ----------------------------------------------
schoolhouse <- split(schoolhouse_table, 1:4) %>% as.data.frame()
names(schoolhouse) <- c("Date_Time", "Raw_Count", "Amount_inches", "Accumulated_inches")
rownames(schoolhouse) <- 1:nrow(schoolhouse)
schoolhouse <- schoolhouse[2:nrow(schoolhouse), ]

# HOLLYWOOD RESEVOIR RAIN GAUGE - recorded hourly

hollywood_scrape <- read_html("http://dpw.lacounty.gov/wrd/precip/alert_rain/season_raindata.cfm?id=312")

hollywood_table <- hollywood_scrape %>% html_nodes("td, th") %>% html_text() %>% as.data.frame()
hollywood_table <- hollywood_table[2:nrow(hollywood_table), 1] %>% as.data.frame()

# Format raw data into table ----------------------------------------------
hollywood <- split(hollywood_table, 1:4) %>% as.data.frame()
names(hollywood) <- c("Date_Time", "Raw_Count", "Amount_inches", "Accumulated_inches")
rownames(hollywood) <- 1:nrow(hollywood)
hollywood <- hollywood[2:nrow(hollywood), ]

# Create new precipitation datasets - averages of certain rain guages per region to be more accurate
# For LA metro, use 2-gauge average (USC, LA Ducommun).
# used for rain barrels, green infrastructure (GI), and incidental capture
# LA_precip <- mean(USC[1,4], ducommun[1,4])     ---    not working because of whitespace in the dataset 
# to continue testing the script, temporarily set to ducommun
LA_precip = ducommun 

# for San Fernando Valley, use average of Schoolhouse DB (gauge 450) and Hollywood resevoir (gauge 312)
# to continue testing the script, temporarily set to hollywood
SFV_precip = hollywood 
```

## Spreading Grounds

Total capture this season

```{r}
# load the RSocrata package
library(RSocrata)
#Read spreading ground capture dataset
spreading <- read.socrata("https://data.lacity.org/A-Livable-and-Sustainable-City/Spreading-Grounds-Centralized-Monthly-Capture/cy8h-q3bu")
#prep data
spreading <- na.omit(spreading)

#load dplyr if not already
library(dplyr)
#calculate spreading ground capture this season
this_season <- spreading %>% select(-Month) %>% group_by(Rain.Season) %>% summarize_all(sum) %>%
  filter(Rain.Season == "2017-2018") %>% select(-Rain.Season)
#sum all spreading grounds to get cumulative 
spreading_capture <- rowSums(this_season)
```

Spreading Ground capture this season = `r spreading_capture` acre feet.

## Rain Barrels and Cisterns

```{r}
# Read capture capacity dataset
# load the RSocrata package if not already
library(RSocrata)
# Read rain barrels & cisterns capacity dataset
barrels <- read.socrata("https://data.lacity.org/A-Livable-and-Sustainable-City/Rain-Barrels-And-Cisterns-Issued-Through-LAWDP-Reb/a5vt-xsyi")
#prep data
barrels <- na.omit(barrels)

# Read precipitation dataset for LA metro
glimpse(LA_precip)

# Perform calculations to get total capture this season
# Precipitation in LA metro * Unit Capture (AFY) for rain barrels and small, medium, large cisterns 
rb_unit_capture = 0.0019
sc_unit_capture = 0.0076
mc_unit_capture = 0.0094
lc_unit_capture = 0.0108

# Not working because of whitespace
#total_rainfall_LA <- last(LA_precip$Accumulated_inches)
#today_rainfall_LA <- last(LA_precip$Amount_inches)

# manually inputting numbers
head(LA_precip)
total_rainfall_LA = 2.75 #inches
today_rainfall_LA = 0 

head(SFV_precip)
total_rainfall_SFV = 3.73 #inches
today_rainfall_SFV = 0 
                         
# Total residential rain barrel capture, todays capture
rb_capture_total <-  total_rainfall_LA * rb_unit_capture * last(barrels$Rain.Barrels)
rb_capture_today <-  today_rainfall_LA * rb_unit_capture * last(barrels$Rain.Barrels)

# Total small cistern capture, today's small cistern capture
sc_capture_total = total_rainfall_LA * sc_unit_capture * last(barrels$Residential..Small..Cisterns)
mc_capture_total = total_rainfall_LA * mc_unit_capture * last(barrels$Medium.Cisterns)
lc_capture_total = total_rainfall_LA * lc_unit_capture * last(barrels$Large.Cisterns )

sc_capture_today = today_rainfall_LA * sc_unit_capture
mc_capture_today = today_rainfall_LA * mc_unit_capture
lc_capture_today = today_rainfall_LA * lc_unit_capture

# Total capture via this method
barrels_and_cisterns_capture = sum(rb_capture_total, sc_capture_total, mc_capture_total, lc_capture_total)
barrels_and_cisterns_today = sum(rb_capture_today, sc_capture_today, mc_capture_today, lc_capture_today)
```

Rain barrels and cisterns capture this season = `r barrels_and_cisterns_capture` acre feet.
Rain barrels and cisterns capture today = `r barrels_and_cisterns_today` acre feet.

## Incidental Capture

```{r}
# No capacity dataset - use a static numbers of average incidental capture per season
# Average year capture for San Fernando Valley is 29,900 Acre Ft according to the Stormwater Capture Master Plan
incidental_avg_SFV <- 29900
# Average year capture for LA Metro area is 5,100 Acre Ft 
incidental_avg_LA <- 5100

# Calculate incidental capture this season and today
# Percentage of average capture this season represents - Annual rainfall per season assume 18.73 inches 
incidental_LA_total <- (total_rainfall_LA/18.73) * incidental_avg_LA

# For SFV, use average of Schoolhouse DB (gauge 450) and Hollywood resevoir (gauge 312)
# For now using LA rainfall
incidental_SFV_total <- (total_rainfall_SFV/18.73) * incidental_avg_LA

incidental_LA_today <- (today_rainfall_LA/18.73) * incidental_avg_LA
incidental_SFV_today <- (today_rainfall_SFv/18.73) * incidental_avg_LA

# Total capture via this method
incidental_capture = sum(incidental_LA_total, incidental_SFV_total)
incidental_today = sum(incidental_LA_today, incidental_SFV_today)
```

Incidental Capture this season = `r incidental_capture` acre feet.
Incidental Capture today = `r incidental_today` acre feet.

## Green Infrastructure

```{r}
# Read GI projects dataset
GI <- read.socrata("https://data.lacity.org/A-Livable-and-Sustainable-City/Green-Infrastructure-Water-Capture-Capacity/pdbw-x3k8")

# Split by project type - need updated dataset

# Total capture via this method
GI_capture = sum(GI$Drainage.Area...Acres.) * total_rainfall_LA
GI_today = sum(GI$Drainage.Area...Acres.) * today_rainfall_LA
```

Green Infrastructure Capture this season = `r GI_capture` acre feet.
Green Infrastructure Capture today = `r GI_today` acre feet.

## Total Capture - All Methods
```{r}
# Read table of total capture 
total_capture <- read.socrata("https://data.lacity.org/A-Livable-and-Sustainable-City/Water-Capture-by-Method/xe35-4wsy")

## NOT WORKING - AIDA PLS HELP! :)
# Create data frame to replace dataset - can switch to append later if we want
# Record today's date time stamp and the capture per method
library(lubridate)
Sys.setenv(TZ="America/Los_Angeles")
now()
total_capture$Timestamp <- as.POSIXct(total_capture$Timestamp)

new_row <- data.frame(now(), spreading_capture, barrels_and_cisterns_capture, barrels_and_cisterns_today, incidental_capture,	incidental_today, GI_capture, GI_today)
new_row$combined <- sum(spreading_capture, barrels_and_cisterns_capture, incidental_capture, GI_capture)
names(new_row) <- c("Timestamp", "spreading_capture", "barrels_and_cisterns_capture", "barrels_and_cisterns_today", "incidental_capture",	"incidental_today", "GI_capture", "GI_today", "Total.Water.Capture")

names(total_capture) <- c("Timestamp", "spreading_capture", "barrels_and_cisterns_capture", "barrels_and_cisterns_today", "incidental_capture",	"incidental_today", "GI_capture", "GI_today", "Total.Water.Capture")

new_dataset <- rbind(total_capture, new_row)

# Write table to Socrata using RSocrata package
write.socrata(dataframe = new_dataset,
              dataset_json_endpoint = "https://data.lacity.org/resource/bnhe-q7a5.json",
              update_mode = "REPLACE",
              email = "chelsea.ursaner@lacity.org",
              password = "California1$")

write.csv(new_dataset, "water_capture_by_method.csv", row.names=F)
 ```

## Number of Projects ***Is this included in the final scope?
```{r}
# Read dataset

# Get total number of projects
```

